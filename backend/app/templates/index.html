<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pipeline Tester</title>
  <style>
    body{font-family:system-ui,Arial;margin:2rem;max-width:1000px}
    .row{display:flex;gap:1rem;align-items:flex-start}
    .card{border:1px solid #ddd;border-radius:12px;padding:1rem}
    img{max-width:100%;height:auto;border-radius:8px}
    code{white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Upload image ‚Üí Run SAM ‚Üí ResNet ‚Üí Zero-shot</h1>

  <!-- ‚úÖ IDs now match what the script expects -->
  <form id="upload-form" class="card">
    <input type="file" name="file" accept="image/*" required />
    <br><br>
    <label>Candidate labels (comma-separated):</label><br/>
    <input type="text" name="candidate_labels"
           placeholder="car, cat, tree, dog, building, person, sky, ground, hardware"
           style="width:100%"/>
    <br><br>
    <button type="submit">Run full pipeline</button>
  </form>

  <div class="row" style="margin-top:2rem;">
    <div style="flex:1">
      <h3>Original</h3>
      <img id="uploaded" src="" alt="uploaded preview"/>
      <h3 style="margin-top:1rem">Segments</h3>
      <div id="segments"></div>
    </div>
    <div style="flex:1">
      <h3>Raw JSON</h3>
      <pre class="card"><code id="output">{}</code></pre>

      <!-- üîΩ dropdown for counting mapped labels -->
      <div id="countBox" class="card" style="display:none;margin-top:1rem">
        <b>Count mapped label</b>
        <select id="countSelect" style="margin-left:.5rem;padding:.25rem .5rem"></select>
        <button id="countBtn" style="margin-left:.5rem;padding:.25rem .5rem">Show count</button>
        <span id="countOut" style="margin-left:.75rem;font-weight:bold"></span>
      </div>
    </div>
  </div>

  <script>
  const form = document.getElementById('upload-form');
  const img = document.getElementById('uploaded');
  const output = document.getElementById('output');
  const segmentsDiv = document.getElementById('segments');

  const countBox = document.getElementById('countBox');
  const countSelect = document.getElementById('countSelect');
  const countBtn = document.getElementById('countBtn');
  const countOut = document.getElementById('countOut');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const res = await fetch('/api/predict/full', { method: 'POST', body: fd });
    const data = await res.json();

    // show image + raw json
    img.src = data.image_path;
    output.textContent = JSON.stringify(data, null, 2);

    // render segments
    segmentsDiv.innerHTML = '';
    (data.segments || []).forEach((s, idx) => {
      const card = document.createElement('div');
      card.style = 'display:flex;gap:10px;align-items:flex-start;margin:.5rem 0;border:1px solid #eee;border-radius:8px;padding:.5rem';
      const im = document.createElement('img');
      im.src = s.mask_path; im.style = 'height:120px;border-radius:6px';
      const p = document.createElement('div');
      const mapped = s.mapped_label ? ` ‚Üí Mapped: <b>${s.mapped_label}</b>` : '';
      const topZS = s.zeroshot_scores
        ? Object.entries(s.zeroshot_scores).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k}: ${(v*100).toFixed(1)}%`).join(' ¬∑ ')
        : '‚Äî';
      const topRN = s.resnet_probs
        ? Object.entries(s.resnet_probs).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v])=>`${k}: ${(v*100).toFixed(1)}%`).join(' ¬∑ ')
        : '‚Äî';
      p.innerHTML = `
        <div><b>Seg ${idx+1}</b> |
          Box: (${s.box.x1},${s.box.y1})‚Äì(${s.box.x2},${s.box.y2}) |
          Score: ${(s.box.score ?? 0).toFixed(3)} |
          ResNet: <b>${s.label ?? '‚Äî'}</b>${mapped}
        </div>
        <div style="font-size:.9rem;margin-top:.25rem">
          ZS top: ${topZS}<br/>
          ResNet top-5: ${topRN}
        </div>`;
      card.appendChild(im); card.appendChild(p);
      segmentsDiv.appendChild(card);
    });

    // populate dropdown from labels actually used
    const labels = data.candidate_labels || [];
    countSelect.innerHTML = labels.map(l => `<option value="${l}">${l}</option>`).join('');
    countBox.style.display = labels.length ? 'block' : 'none';

    // show mapped count for selected label
    countBtn.onclick = () => {
      const label = countSelect.value;
      const c = (data.counts?.mapped || {})[label] || 0;
      countOut.textContent = `Mapped count for ‚Äú${label}‚Äù: ${c}`;
    };
  });
  </script>
</body>
</html>
